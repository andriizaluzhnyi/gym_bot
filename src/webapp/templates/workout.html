<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Тренування</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-color: #0a0a0a;
            --card-bg: #1a1a1a;
            --card-border: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --text-muted: #666666;
            --accent: #5e9cff;
            --accent-light: rgba(94, 156, 255, 0.1);
            --accent-green: #4ade80;
            --diff-positive: #4ade80;
            --diff-negative: #ef4444;
            --input-bg: #111111;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-theme-bg-color, var(--bg-color));
            color: var(--tg-theme-text-color, var(--text-primary));
            min-height: 100vh;
            padding: 0;
            padding-bottom: 100px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--card-border);
            position: sticky;
            top: 0;
            background-color: var(--tg-theme-bg-color, var(--bg-color));
            z-index: 10;
        }

        .header-date {
            font-size: 18px;
            font-weight: 600;
        }

        .header-user {
            font-size: 13px;
            color: var(--tg-theme-hint-color, var(--text-secondary));
        }

        /* Exercise list view */
        .exercise-list-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid var(--card-border);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.15s;
        }

        .exercise-list-item:active {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .exercise-list-item.completed-item {
            opacity: 0.5;
        }

        .exercise-list-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: var(--card-border);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-right: 14px;
            overflow: hidden;
        }

        .exercise-list-icon svg {
            width: 24px;
            height: 24px;
            stroke: var(--text-secondary);
        }

        .exercise-list-info {
            flex: 1;
            min-width: 0;
        }

        .exercise-list-name {
            font-size: 15px;
            font-weight: 500;
            color: var(--tg-theme-text-color, var(--text-primary));
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .exercise-list-plan {
            font-size: 13px;
            color: var(--tg-theme-hint-color, var(--text-muted));
        }

        .exercise-list-comment {
            font-size: 12px;
            color: var(--tg-theme-hint-color, var(--text-muted));
            font-style: italic;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .exercise-list-status {
            flex-shrink: 0;
            margin-left: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .exercise-list-status .sets-count {
            font-size: 12px;
            color: var(--tg-theme-hint-color, var(--text-muted));
        }

        .exercise-list-status svg {
            width: 22px;
            height: 22px;
        }

        /* Exercise detail view */
        .exercise-detail {
            padding: 16px;
        }

        .exercise-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--tg-theme-text-color, var(--text-primary));
        }

        .exercise-plan {
            font-size: 13px;
            color: var(--tg-theme-hint-color, var(--text-muted));
            margin-bottom: 4px;
        }

        .exercise-comment {
            font-size: 13px;
            color: var(--tg-theme-hint-color, var(--text-muted));
            font-style: italic;
            margin-bottom: 16px;
        }

        .muscle-group-badge {
            display: inline-block;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            background-color: var(--card-border);
            color: var(--tg-theme-hint-color, var(--text-secondary));
            margin-bottom: 8px;
        }

        /* Sets table */
        .sets-table {
            width: 100%;
            border-collapse: collapse;
        }

        .sets-table th {
            font-size: 12px;
            font-weight: 500;
            color: var(--tg-theme-hint-color, var(--text-secondary));
            text-align: center;
            padding: 6px 4px;
        }

        .sets-table th:first-child {
            width: 30px;
            text-align: left;
        }

        .sets-table td {
            padding: 6px 4px;
            text-align: center;
            vertical-align: middle;
        }

        .sets-table td:first-child {
            text-align: left;
            font-size: 14px;
            font-weight: 500;
            color: var(--tg-theme-hint-color, var(--text-secondary));
        }

        .set-row {
            border-bottom: 1px solid var(--card-border);
        }

        .set-row:last-child {
            border-bottom: none;
        }

        .input-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
        }

        .set-input {
            width: 60px;
            padding: 8px 4px;
            border: none;
            border-radius: 8px;
            background-color: var(--tg-theme-secondary-bg-color, var(--input-bg));
            color: var(--tg-theme-text-color, var(--text-primary));
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            outline: none;
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }

        .set-input::-webkit-inner-spin-button,
        .set-input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .set-input:focus {
            box-shadow: 0 0 0 2px var(--tg-theme-button-color, var(--accent));
        }

        .diff {
            font-size: 11px;
            font-weight: 600;
            margin-left: 1px;
            vertical-align: super;
        }

        .diff-positive {
            color: var(--diff-positive);
        }

        .diff-negative {
            color: var(--diff-negative);
        }

        .diff-zero {
            color: var(--tg-theme-hint-color, var(--text-muted));
        }

        .last-workout {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            margin-top: 12px;
            font-size: 12px;
            color: var(--tg-theme-link-color, #4fc3f7);
            cursor: pointer;
        }

        .last-workout-arrow {
            font-size: 14px;
        }

        .no-sets-hint {
            text-align: center;
            padding: 24px 16px;
            color: var(--tg-theme-hint-color, var(--text-muted));
            font-size: 14px;
        }

        .add-set-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            margin: 16px auto;
            border-radius: 50%;
            border: 2px solid var(--accent);
            background: transparent;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s;
        }

        .add-set-btn svg {
            width: 28px;
            height: 28px;
            stroke: var(--accent);
            stroke-width: 2;
        }

        .add-set-btn:active {
            transform: scale(0.9);
            background-color: var(--accent-light);
        }

        .remove-set-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            color: var(--diff-negative);
            font-size: 16px;
            cursor: pointer;
            opacity: 0.6;
            -webkit-tap-highlight-color: transparent;
        }

        .remove-set-btn:active {
            opacity: 1;
        }

        /* Complete exercise button */
        .complete-exercise-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: calc(100% - 32px);
            margin: 20px auto 0;
            padding: 12px;
            border: 1px solid var(--accent);
            border-radius: 12px;
            background: transparent;
            color: var(--accent);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s;
        }

        .complete-exercise-btn:active {
            background-color: var(--accent-light);
        }

        .complete-exercise-btn svg {
            width: 20px;
            height: 20px;
            stroke: var(--accent);
            stroke-width: 2;
        }

        /* Bottom bar with timer */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--tg-theme-bg-color, var(--bg-color));
            border-top: 1px solid var(--card-border);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 20;
        }

        .timer-section {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: var(--tg-theme-hint-color, var(--text-secondary));
        }

        .timer-section svg {
            width: 18px;
            height: 18px;
            stroke: var(--tg-theme-hint-color, var(--text-secondary));
        }

        .timer-value {
            font-variant-numeric: tabular-nums;
            min-width: 40px;
        }

        .rest-timer-section {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: var(--tg-theme-hint-color, var(--text-secondary));
        }

        .rest-timer-section svg {
            width: 18px;
            height: 18px;
            stroke: var(--tg-theme-hint-color, var(--text-secondary));
        }

        .rest-timer-active {
            color: var(--accent);
        }

        .rest-timer-active svg {
            stroke: var(--accent);
        }

        .finish-workout-btn {
            display: block;
            width: calc(100% - 32px);
            margin: 20px auto;
            padding: 14px;
            border: none;
            border-radius: 12px;
            background-color: var(--accent);
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            transition: opacity 0.2s;
        }

        .finish-workout-btn:active {
            opacity: 0.8;
        }

        .finish-workout-btn:disabled {
            opacity: 0.4;
            cursor: default;
        }

        /* Confirm modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 20px;
        }

        .modal-content {
            background-color: var(--tg-theme-bg-color, var(--card-bg));
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            max-width: 320px;
            text-align: center;
        }

        .modal-title {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .modal-text {
            font-size: 14px;
            color: var(--tg-theme-hint-color, var(--text-secondary));
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            border: none;
        }

        .modal-btn-cancel {
            background-color: var(--card-border);
            color: var(--tg-theme-text-color, var(--text-primary));
        }

        .modal-btn-confirm {
            background-color: var(--accent);
            color: #fff;
        }

        /* Add Set Modal */
        .add-set-modal .modal-content {
            max-width: 400px;
        }

        .add-set-field {
            margin-bottom: 20px;
        }

        .add-set-field-label {
            font-size: 14px;
            color: var(--tg-theme-hint-color, var(--text-secondary));
            margin-bottom: 8px;
            text-align: left;
        }

        .add-set-field-value {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }

        .add-set-field-btn {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            border: 1px solid var(--card-border);
            background-color: var(--card-bg);
            color: var(--accent);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .add-set-field-btn:active {
            background-color: var(--accent-light);
        }

        .add-set-field-input {
            width: 120px;
            height: 56px;
            font-size: 32px;
            font-weight: 600;
            text-align: center;
            background-color: transparent;
            border: none;
            color: var(--tg-theme-text-color, var(--text-primary));
            outline: none;
        }

        .add-set-effort-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .effort-btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid var(--card-border);
            background-color: var(--card-bg);
            color: var(--tg-theme-text-color, var(--text-secondary));
            font-size: 13px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s;
        }

        .effort-btn.selected {
            background-color: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            font-size: 16px;
            color: var(--tg-theme-hint-color, var(--text-secondary));
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--tg-theme-hint-color, var(--text-muted));
        }

        .empty-state p {
            margin-bottom: 8px;
        }

        /* Delete buttons */
        .delete-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: #ef4444;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.15s;
        }

        .delete-btn:active {
            background-color: rgba(239, 68, 68, 0.1);
        }

        .delete-btn svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
        }

        .header-delete-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: #ef4444;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.15s;
        }

        .header-delete-btn:active {
            background-color: rgba(239, 68, 68, 0.1);
        }
    </style>
</head>
<body>
    <div class="header" id="header">
        <div>
            <div class="header-date" id="headerDate"></div>
            <div class="header-user" id="headerUser"></div>
        </div>
        <button class="header-delete-btn" id="deleteDayBtn" style="display:none;">
            Видалити день
        </button>
    </div>

    <div id="mainContainer">
        <div class="loading" id="loadingState">Завантаження програми...</div>
    </div>

    <div id="modalContainer"></div>

    <div class="bottom-bar" id="bottomBar" style="display:none;">
        <div class="timer-section" id="workoutTimer">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <span class="timer-value" id="workoutTimerValue">00:00</span>
        </div>
        <div class="rest-timer-section" id="restTimer">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round">
                <path d="M18.5 2h-13a1.5 1.5 0 00-1.5 1.5v1A1.5 1.5 0 005.5 6h13A1.5 1.5 0 0020 4.5v-1A1.5 1.5 0 0018.5 2z"></path>
                <path d="M7 6v2.5C7 12.5 9.5 14 12 17c2.5-3 5-4.5 5-8.5V6"></path>
            </svg>
            <span class="timer-value" id="restTimerValue">00:00</span>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const urlParams = new URLSearchParams(window.location.search);
        const PARAM_USER = urlParams.get('user') || '';
        const PARAM_DAY = urlParams.get('day') || '';
        const PARAM_MUSCLE = urlParams.get('muscle') || '';

        // State
        let exercises = [];
        let lastLogs = {};
        let currentView = 'list';
        let activeExerciseIndex = 0;
        let backButtonHandler = null;

        // Timers
        let workoutStartTime = null;
        let workoutTimerInterval = null;
        let restStartTime = null;
        let restTimerInterval = null;
        let restTimerDuration = 60; // 1 minute in seconds
        let restTimerAudio = null;
        let restNotificationScheduled = false; // Track if notification is already scheduled

        // Storage key for current session
        const STORAGE_KEY = `workout_session_${PARAM_USER}_${PARAM_DAY}_${PARAM_MUSCLE}`;

        function saveWorkoutSession() {
            try {
                const sessionData = {
                    exercises: exercises,
                    workoutStartTime: workoutStartTime,
                    activeExerciseIndex: activeExerciseIndex,
                    savedAt: Date.now()
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(sessionData));
            } catch (error) {
                console.log('Failed to save session:', error);
            }
        }

        function loadWorkoutSession() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (!saved) return false;

                const sessionData = JSON.parse(saved);

                // Check if session is less than 24 hours old
                const age = Date.now() - sessionData.savedAt;
                if (age > 24 * 60 * 60 * 1000) {
                    localStorage.removeItem(STORAGE_KEY);
                    return false;
                }

                exercises = sessionData.exercises;
                workoutStartTime = sessionData.workoutStartTime;
                activeExerciseIndex = sessionData.activeExerciseIndex;
                return true;
            } catch (error) {
                console.log('Failed to load session:', error);
                return false;
            }
        }

        function clearWorkoutSession() {
            try {
                localStorage.removeItem(STORAGE_KEY);
            } catch (error) {
                console.log('Failed to clear session:', error);
            }
        }

        function setBackButton(handler) {
            if (backButtonHandler) {
                tg.BackButton.offClick(backButtonHandler);
            }
            backButtonHandler = handler;
            tg.BackButton.onClick(handler);
            tg.BackButton.show();
        }

        function initHeader() {
            const now = new Date();
            const dateStr = `${String(now.getDate()).padStart(2, '0')}.${String(now.getMonth() + 1).padStart(2, '0')}.${now.getFullYear()}`;
            document.getElementById('headerDate').textContent = dateStr;
            document.getElementById('headerUser').textContent = PARAM_USER;
        }

        // --- Modal ---

        function showModal(title, text, onConfirm, onCancel) {
            const container = document.getElementById('modalContainer');
            container.innerHTML = `
                <div class="modal-overlay" id="modalOverlay">
                    <div class="modal-content">
                        <div class="modal-title">${title}</div>
                        <div class="modal-text">${text}</div>
                        <div class="modal-buttons">
                            <button class="modal-btn modal-btn-cancel" id="modalCancel">Скасувати</button>
                            <button class="modal-btn modal-btn-confirm" id="modalConfirm">Так</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalCancel').addEventListener('click', () => {
                container.innerHTML = '';
                if (onCancel) onCancel();
            });
            document.getElementById('modalConfirm').addEventListener('click', () => {
                container.innerHTML = '';
                if (onConfirm) onConfirm();
            });
            document.getElementById('modalOverlay').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    container.innerHTML = '';
                    if (onCancel) onCancel();
                }
            });
        }

        function showAddSetModal(onConfirm) {
            const ex = exercises[activeExerciseIndex];
            const setIndex = ex._sets.length;
            const plannedReps = getPlannedRepsForSet(ex.sets_reps, setIndex);
            const lastLog = lastLogs[ex.exercise];
            const prevSet = lastLog && lastLog.sets && lastLog.sets[setIndex];

            let weight = prevSet ? prevSet.weight : '';
            let reps = plannedReps || (prevSet ? prevSet.reps : '');

            const container = document.getElementById('modalContainer');

            function render() {
                container.innerHTML = `
                    <div class="modal-overlay add-set-modal" id="modalOverlay">
                        <div class="modal-content">
                            <div class="modal-title">Додати підхід</div>

                            <div class="add-set-field">
                                <div class="add-set-field-label">Weight</div>
                                <div class="add-set-field-value">
                                    <button class="add-set-field-btn" id="weightMinus">−</button>
                                    <input type="number" class="add-set-field-input" id="weightInput"
                                           inputmode="decimal" value="${weight}" placeholder="0">
                                    <button class="add-set-field-btn" id="weightPlus">+</button>
                                </div>
                            </div>

                            <div class="add-set-field">
                                <div class="add-set-field-label">Repeats</div>
                                <div class="add-set-field-value">
                                    <button class="add-set-field-btn" id="repsMinus">−</button>
                                    <input type="number" class="add-set-field-input" id="repsInput"
                                           inputmode="numeric" value="${reps}" placeholder="0">
                                    <button class="add-set-field-btn" id="repsPlus">+</button>
                                </div>
                            </div>

                            <div class="modal-buttons">
                                <button class="modal-btn modal-btn-cancel" id="modalCancel">CANCEL</button>
                                <button class="modal-btn modal-btn-confirm" id="modalAdd">ADD</button>
                            </div>
                        </div>
                    </div>
                `;

                // Weight controls
                const weightInput = document.getElementById('weightInput');
                document.getElementById('weightMinus').addEventListener('click', () => {
                    const val = parseFloat(weightInput.value) || 0;
                    weight = Math.max(0, val - 2.5);
                    weightInput.value = weight;
                    if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
                });
                document.getElementById('weightPlus').addEventListener('click', () => {
                    const val = parseFloat(weightInput.value) || 0;
                    weight = val + 2.5;
                    weightInput.value = weight;
                    if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
                });
                weightInput.addEventListener('focus', () => {
                    weightInput.select();
                });
                weightInput.addEventListener('input', (e) => {
                    weight = e.target.value;
                });

                // Reps controls
                const repsInput = document.getElementById('repsInput');
                document.getElementById('repsMinus').addEventListener('click', () => {
                    const val = parseInt(repsInput.value) || 0;
                    reps = Math.max(0, val - 1);
                    repsInput.value = reps;
                    if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
                });
                document.getElementById('repsPlus').addEventListener('click', () => {
                    const val = parseInt(repsInput.value) || 0;
                    reps = val + 1;
                    repsInput.value = reps;
                    if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
                });
                repsInput.addEventListener('focus', () => {
                    repsInput.select();
                });
                repsInput.addEventListener('input', (e) => {
                    reps = e.target.value;
                });

                // Cancel/Add buttons
                document.getElementById('modalCancel').addEventListener('click', () => {
                    container.innerHTML = '';
                });
                document.getElementById('modalAdd').addEventListener('click', () => {
                    container.innerHTML = '';
                    onConfirm({ weight, reps });
                });
                document.getElementById('modalOverlay').addEventListener('click', (e) => {
                    if (e.target === e.currentTarget) {
                        container.innerHTML = '';
                    }
                });
            }

            render();
        }

        function showRestTimerModal() {
            const container = document.getElementById('modalContainer');

            const presetTimes = [
                { label: '30 сек', value: 30 },
                { label: '1 хв', value: 60 },
                { label: '1.5 хв', value: 90 },
                { label: '2 хв', value: 120 },
                { label: '3 хв', value: 180 },
                { label: '5 хв', value: 300 },
            ];

            container.innerHTML = `
                <div class="modal-overlay add-set-modal" id="modalOverlay">
                    <div class="modal-content">
                        <div class="modal-title">Час відпочинку</div>

                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 16px;">
                            ${presetTimes.map(t => `
                                <button class="modal-btn modal-btn-confirm preset-time-btn" data-time="${t.value}">
                                    ${t.label}
                                </button>
                            `).join('')}
                        </div>

                        <div class="add-set-field" style="margin-bottom: 16px;">
                            <div class="add-set-field-label">Або власний час (сек)</div>
                            <div class="add-set-field-value">
                                <button class="add-set-field-btn" id="timeMinus">−</button>
                                <input type="number" class="add-set-field-input" id="customTimeInput"
                                       inputmode="numeric" value="${restTimerDuration}" placeholder="60">
                                <button class="add-set-field-btn" id="timePlus">+</button>
                            </div>
                        </div>

                        <div class="modal-buttons">
                            <button class="modal-btn modal-btn-cancel" id="modalCancel">Скасувати</button>
                            <button class="modal-btn modal-btn-confirm" id="modalStart">Старт</button>
                        </div>
                    </div>
                </div>
            `;

            // Preset time buttons
            container.querySelectorAll('.preset-time-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const time = parseInt(btn.dataset.time);
                    restTimerDuration = time;
                    container.innerHTML = '';
                    resetRestTimer();
                    if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
                });
            });

            // Custom time controls
            let customTime = restTimerDuration;
            const customInput = document.getElementById('customTimeInput');

            document.getElementById('timeMinus').addEventListener('click', () => {
                const val = parseInt(customInput.value) || 0;
                customTime = Math.max(10, val - 10);
                customInput.value = customTime;
                if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
            });

            document.getElementById('timePlus').addEventListener('click', () => {
                const val = parseInt(customInput.value) || 0;
                customTime = val + 10;
                customInput.value = customTime;
                if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
            });

            customInput.addEventListener('focus', () => {
                customInput.select();
            });

            customInput.addEventListener('input', (e) => {
                customTime = parseInt(e.target.value) || 60;
            });

            // Cancel/Start buttons
            document.getElementById('modalCancel').addEventListener('click', () => {
                container.innerHTML = '';
            });

            document.getElementById('modalStart').addEventListener('click', () => {
                restTimerDuration = customTime;
                container.innerHTML = '';
                resetRestTimer();
                if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
            });

            document.getElementById('modalOverlay').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    container.innerHTML = '';
                }
            });
        }

        // --- Timer functions ---

        function formatTimer(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        function startWorkoutTimer() {
            if (!workoutStartTime) {
                workoutStartTime = Date.now();
                saveWorkoutSession();
            }
            workoutTimerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - workoutStartTime) / 1000);
                document.getElementById('workoutTimerValue').textContent = formatTimer(elapsed);
            }, 1000);
        }

        function resetRestTimer() {
            restStartTime = Date.now();
            if (restTimerInterval) clearInterval(restTimerInterval);

            const restEl = document.getElementById('restTimer');
            restEl.classList.add('rest-timer-active');
            document.getElementById('restTimerValue').textContent = formatTimer(restTimerDuration);

            // Schedule Telegram notification only if not already scheduled
            if (!restNotificationScheduled) {
                scheduleRestTimerNotification(restTimerDuration);
                restNotificationScheduled = true;
            }

            restTimerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - restStartTime) / 1000);
                const remaining = restTimerDuration - elapsed;

                if (remaining <= 0) {
                    clearInterval(restTimerInterval);
                    document.getElementById('restTimerValue').textContent = '00:00';
                    playRestTimerSound();
                    restEl.classList.remove('rest-timer-active');
                    restNotificationScheduled = false; // Reset flag when timer completes
                } else {
                    document.getElementById('restTimerValue').textContent = formatTimer(remaining);
                }
            }, 1000);
        }

        async function scheduleRestTimerNotification(durationSeconds) {
            try {
                const response = await fetch('/api/workout/rest-timer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': tg.initData,
                    },
                    body: JSON.stringify({
                        duration_seconds: durationSeconds,
                        user: PARAM_USER,
                        day: PARAM_DAY,
                        muscle: PARAM_MUSCLE,
                    }),
                });

                if (!response.ok) {
                    console.log('Failed to schedule notification');
                }
            } catch (error) {
                console.log('Error scheduling notification:', error);
            }
        }

        function playRestTimerSound() {
            // Try multiple methods to notify user when phone might be locked

            // Method 1: Telegram Haptic Feedback (works even when locked)
            if (tg.HapticFeedback) {
                // Triple notification for stronger feedback
                tg.HapticFeedback.notificationOccurred('warning');
                setTimeout(() => tg.HapticFeedback.notificationOccurred('warning'), 100);
                setTimeout(() => tg.HapticFeedback.notificationOccurred('success'), 200);
            }

            // Method 2: Strong vibration pattern (works when phone unlocked)
            if (navigator.vibrate) {
                // Longer vibration pattern to ensure user notices
                navigator.vibrate([300, 100, 300, 100, 300]);
            }

            // Method 3: Web Audio API (only works when app is active)
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                const audioContext = new AudioContext();

                const playTone = (freq, startTime, duration) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.value = freq;
                    oscillator.type = 'sine';

                    gainNode.gain.setValueAtTime(0.3, startTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);

                    oscillator.start(startTime);
                    oscillator.stop(startTime + duration);
                };

                // Two-tone notification: high-low
                const now = audioContext.currentTime;
                playTone(1000, now, 0.15);        // First tone: 1000 Hz
                playTone(800, now + 0.17, 0.2);   // Second tone: 800 Hz
            } catch (error) {
                console.log('Audio playback failed:', error);
            }

            // Note: Telegram bot notification will be sent separately
        }

        // --- Parsing ---

        /**
         * Parse sets/reps string into groups.
         * Formats:
         *   "4/20"       -> 4 sets of 20 reps (sets/reps)
         *   "4x10"       -> 4 sets of 10 reps
         *   "1x20, 4x12" -> 1 set of 20 + 4 sets of 12
         */
        function parseSetsReps(setsReps) {
            if (!setsReps) return [{ reps: 0, count: 1 }];
            const trimmed = setsReps.trim();
            const parts = trimmed.split(',').map(s => s.trim());
            const result = [];

            for (const part of parts) {
                if (part.includes('x')) {
                    const [count, reps] = part.split('x').map(Number);
                    if (!isNaN(count) && !isNaN(reps)) {
                        result.push({ reps, count });
                    }
                } else if (part.includes('/')) {
                    // Format: sets/reps (e.g. "4/20" = 4 sets of 20 reps)
                    const [sets, reps] = part.split('/').map(Number);
                    if (!isNaN(sets) && !isNaN(reps)) {
                        result.push({ reps, count: sets });
                    }
                }
            }

            return result.length === 0 ? [{ reps: 0, count: 1 }] : result;
        }

        /**
         * Get planned reps for a given set index from parsed sets/reps.
         * Used as placeholder hint when adding sets.
         */
        function getPlannedRepsForSet(setsReps, setIndex) {
            const parsed = parseSetsReps(setsReps);
            let idx = 0;
            for (const group of parsed) {
                for (let i = 0; i < group.count; i++) {
                    if (idx === setIndex) return group.reps;
                    idx++;
                }
            }
            return parsed[parsed.length - 1]?.reps || 0;
        }

        function diffHtml(current, previous) {
            // Don't show diff if no previous value exists or current is empty
            if (previous === undefined || previous === null || current === '' || current === null) {
                return '';
            }

            const cur = parseFloat(current);
            const prev = parseFloat(previous);

            // Don't show diff if either value is not a valid number
            if (isNaN(cur) || isNaN(prev)) {
                return '';
            }

            const diff = cur - prev;
            if (diff > 0) return `<span class="diff diff-positive">+${diff}</span>`;
            if (diff < 0) return `<span class="diff diff-negative">${diff}</span>`;
            return `<span class="diff diff-zero">+0</span>`;
        }

        // --- Exercise state helpers ---

        function isExerciseStarted(ex) {
            return ex._sets.length > 0;
        }

        function isExerciseCompleted(ex) {
            return ex._completed === true;
        }

        function getFilledSetsCount(ex) {
            return ex._sets.filter(s => s.weight !== '' || s.reps !== '').length;
        }

        function isLastExercise(idx) {
            return idx === exercises.length - 1;
        }

        // --- Views ---

        function showListView() {
            currentView = 'list';
            const container = document.getElementById('mainContainer');

            if (exercises.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>Немає вправ для цієї програми</p>
                    </div>
                `;
                return;
            }

            let html = '';

            exercises.forEach((ex, idx) => {
                const completed = isExerciseCompleted(ex);
                const filledSets = getFilledSetsCount(ex);
                const totalSets = ex._sets.length;

                let statusHtml = '';
                if (completed) {
                    statusHtml = `<svg viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                } else if (totalSets > 0) {
                    statusHtml = `<span class="sets-count">${filledSets}/${totalSets}</span>`;
                }

                html += `
                    <div class="exercise-list-item${completed ? ' completed-item' : ''}" data-index="${idx}">
                        <div class="exercise-list-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M6.5 6.5h-3a1 1 0 00-1 1v9a1 1 0 001 1h3"></path>
                                <path d="M17.5 6.5h3a1 1 0 011 1v9a1 1 0 01-1 1h-3"></path>
                                <rect x="6.5" y="4" width="4" height="16" rx="1"></rect>
                                <rect x="13.5" y="4" width="4" height="16" rx="1"></rect>
                                <line x1="10.5" y1="12" x2="13.5" y2="12"></line>
                            </svg>
                        </div>
                        <div class="exercise-list-info">
                            <div class="exercise-list-name">${ex.exercise}</div>
                            <div class="exercise-list-plan">${ex.sets_reps || ''}</div>
                            ${ex.comment ? `<div class="exercise-list-comment">${ex.comment}</div>` : ''}
                        </div>
                        <div class="exercise-list-status">${statusHtml}</div>
                        <button class="delete-btn" data-exercise-idx="${idx}" onclick="deleteExercise(event, ${idx})">
                            <svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 6h18"></path>
                                <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"></path>
                                <path d="M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                <line x1="14" y1="11" x2="14" y2="17"></line>
                            </svg>
                        </button>
                    </div>
                `;
            });

            // Show finish button only if at least one exercise has data
            const hasAnyData = exercises.some(ex => getFilledSetsCount(ex) > 0);
            if (hasAnyData) {
                html += `
                    <button class="finish-workout-btn" id="finishWorkoutBtn">
                        Завершити тренування
                    </button>
                `;
            }

            container.innerHTML = html;

            container.querySelectorAll('.exercise-list-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    // Don't open detail view if clicking delete button
                    if (e.target.closest('.delete-btn')) return;

                    const idx = parseInt(item.dataset.index);
                    activeExerciseIndex = idx;
                    showDetailView();
                    if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
                });
            });

            const finishBtn = document.getElementById('finishWorkoutBtn');
            if (finishBtn) {
                finishBtn.addEventListener('click', saveWorkout);
            }

            // Show delete day button
            const deleteDayBtn = document.getElementById('deleteDayBtn');
            if (deleteDayBtn) {
                deleteDayBtn.style.display = 'block';
                deleteDayBtn.onclick = deleteWorkoutDay;
            }

            setBackButton(() => { tg.close(); });
            tg.MainButton.hide();
        }

        function goBackToList() {
            showListView();
            if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
        }

        function showDetailView() {
            currentView = 'detail';
            const container = document.getElementById('mainContainer');
            const ex = exercises[activeExerciseIndex];
            const lastLog = lastLogs[ex.exercise];

            // Hide delete day button in detail view
            const deleteDayBtn = document.getElementById('deleteDayBtn');
            if (deleteDayBtn) {
                deleteDayBtn.style.display = 'none';
            }

            let html = `<div class="exercise-detail">`;

            if (ex.muscle_group) {
                html += `<span class="muscle-group-badge">${ex.muscle_group}</span>`;
            }
            html += `<div class="exercise-name">${ex.exercise}</div>`;
            html += `<div class="exercise-plan">${ex.sets_reps || ''}</div>`;
            if (ex.comment) {
                html += `<div class="exercise-comment">${ex.comment}</div>`;
            } else {
                html += `<div style="margin-bottom:12px"></div>`;
            }

            if (ex._sets.length === 0) {
                // No sets yet - show hint
                html += `<div class="no-sets-hint">Натисніть + щоб додати підхід</div>`;
            } else {
                html += `<table class="sets-table">`;
                html += `<thead><tr>
                    <th></th>
                    <th>Вага</th>
                    <th>Повторення</th>
                    <th></th>
                </tr></thead>`;
                html += `<tbody>`;

                ex._sets.forEach((s, sIdx) => {
                    const prevSet = lastLog && lastLog.sets && lastLog.sets[sIdx];
                    const prevWeight = prevSet ? prevSet.weight : undefined;
                    const prevReps = prevSet ? prevSet.reps : undefined;

                    const weightDiff = diffHtml(s.weight, prevWeight);
                    const repsDiff = diffHtml(s.reps, prevReps);
                    const canRemove = true;

                    html += `<tr class="set-row">
                        <td>${s.set}</td>
                        <td>
                            <div class="input-cell">
                                <input type="number" class="set-input" inputmode="decimal"
                                       placeholder="${prevWeight !== undefined ? prevWeight : '—'}"
                                       value="${s.weight}"
                                       data-exercise="${activeExerciseIndex}"
                                       data-set="${sIdx}"
                                       data-field="weight"
                                       onfocus="this.select()">
                                ${weightDiff}
                            </div>
                        </td>
                        <td>
                            <div class="input-cell">
                                <input type="number" class="set-input" inputmode="numeric"
                                       placeholder="${s.plannedReps || (prevReps !== undefined ? prevReps : '—')}"
                                       value="${s.reps}"
                                       data-exercise="${activeExerciseIndex}"
                                       data-set="${sIdx}"
                                       data-field="reps"
                                       onfocus="this.select()">
                                ${repsDiff}
                            </div>
                        </td>
                        <td>${canRemove ? `<button class="remove-set-btn" data-exercise="${activeExerciseIndex}" data-set="${sIdx}">×</button>` : ''}</td>
                    </tr>`;
                });

                html += `</tbody></table>`;
            }

            if (lastLog) {
                html += `<div class="last-workout">
                    *Останнє тренування ${lastLog.date}
                    <span class="last-workout-arrow">›</span>
                </div>`;
            }

            html += `</div>`;

            // Add set button
            html += `<button class="add-set-btn" id="addSetBtn">
                <svg viewBox="0 0 24 24" fill="none">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </button>`;

            // Complete exercise button
            if (!isExerciseCompleted(ex) && ex._sets.length > 0) {
                const btnLabel = isLastExercise(activeExerciseIndex)
                    ? 'Завершити вправу та тренування'
                    : 'Завершити вправу';
                html += `<button class="complete-exercise-btn" id="completeExerciseBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                        <line x1="4" y1="22" x2="4" y2="15"></line>
                    </svg>
                    ${btnLabel}
                </button>`;
            }

            container.innerHTML = html;

            // Bind input events
            container.querySelectorAll('.set-input').forEach(input => {
                input.addEventListener('input', onSetInput);
            });

            // Bind remove set buttons
            container.querySelectorAll('.remove-set-btn').forEach(btn => {
                btn.addEventListener('click', onRemoveSet);
            });

            // Bind add set button
            document.getElementById('addSetBtn').addEventListener('click', onAddSet);

            // Bind complete exercise button
            const completeBtn = document.getElementById('completeExerciseBtn');
            if (completeBtn) {
                completeBtn.addEventListener('click', onCompleteExercise);
            }

            setBackButton(goBackToList);
            tg.MainButton.hide();
        }

        function onSetInput(e) {
            const exIdx = parseInt(e.target.dataset.exercise);
            const setIdx = parseInt(e.target.dataset.set);
            const field = e.target.dataset.field;
            exercises[exIdx]._sets[setIdx][field] = e.target.value;
            saveWorkoutSession();
        }

        function onAddSet() {
            showAddSetModal((data) => {
                const ex = exercises[activeExerciseIndex];
                const nextSetNum = ex._sets.length + 1;
                const setIndex = ex._sets.length;
                const plannedReps = getPlannedRepsForSet(ex.sets_reps, setIndex);

                ex._sets.push({
                    set: nextSetNum,
                    plannedReps: plannedReps,
                    weight: data.weight || '',
                    reps: data.reps || '',
                });

                showDetailView();
                resetRestTimer();
                saveWorkoutSession();
                if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
            });
        }

        function onRemoveSet(e) {
            const exIdx = parseInt(e.target.dataset.exercise);
            const setIdx = parseInt(e.target.dataset.set);
            exercises[exIdx]._sets.splice(setIdx, 1);
            exercises[exIdx]._sets.forEach((s, i) => { s.set = i + 1; });
            showDetailView();
            saveWorkoutSession();
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        }

        function onCompleteExercise() {
            const ex = exercises[activeExerciseIndex];
            const isLast = isLastExercise(activeExerciseIndex);

            if (isLast) {
                showModal(
                    'Завершити тренування?',
                    'Це остання вправа. Зберегти та завершити тренування?',
                    () => {
                        ex._completed = true;
                        if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                        saveWorkout();
                    }
                );
            } else {
                ex._completed = true;
                saveWorkoutSession();
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                goBackToList();
            }
        }

        // --- API ---

        async function loadProgram() {
            // First try to restore session
            const sessionRestored = loadWorkoutSession();
            if (sessionRestored) {
                console.log('Workout session restored from localStorage');
                return;
            }

            // If no session, load fresh program
            try {
                const params = new URLSearchParams({
                    user: PARAM_USER,
                    day: PARAM_DAY,
                });
                if (PARAM_MUSCLE) params.set('muscle', PARAM_MUSCLE);

                const response = await fetch(`/api/workout/program?${params}`, {
                    headers: { 'Authorization': tg.initData },
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                if (result.success && result.data && result.data.exercises) {
                    exercises = result.data.exercises.map(ex => ({
                        ...ex,
                        _sets: [],          // Start with no sets
                        _completed: false,  // Not completed yet
                    }));
                }
            } catch (err) {
                console.error('Failed to load program:', err);
            }
        }

        async function loadLastLogs() {
            if (exercises.length === 0) return;

            try {
                const exerciseNames = exercises.map(e => e.exercise).join(',');
                const params = new URLSearchParams({
                    user: PARAM_USER,
                    exercises: exerciseNames,
                });

                // Add day parameter if available
                if (PARAM_DAY) {
                    params.append('day', PARAM_DAY);
                }

                const response = await fetch(`/api/workout/last-log?${params}`, {
                    headers: { 'Authorization': tg.initData },
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        lastLogs = result.data;
                    }
                }
            } catch (err) {
                console.error('Failed to load last logs:', err);
            }
        }

        async function saveWorkout() {
            const payload = {
                user: PARAM_USER,
                day: PARAM_DAY,
                muscle: PARAM_MUSCLE,
                duration_seconds: workoutStartTime ? Math.floor((Date.now() - workoutStartTime) / 1000) : 0,
                exercises: exercises.map(ex => ({
                    exercise: ex.exercise,
                    muscle_group: ex.muscle_group || '',
                    planned_sets_reps: ex.sets_reps || '',
                    sets: ex._sets
                        .filter(s => s.weight !== '' || s.reps !== '')
                        .map(s => ({
                            set: s.set,
                            weight: s.weight,
                            reps: s.reps,
                        })),
                })).filter(ex => ex.sets.length > 0),
            };

            if (payload.exercises.length === 0) {
                tg.showAlert('Заповніть хоча б один сет');
                return;
            }

            const btn = document.getElementById('finishWorkoutBtn');
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Збереження...';
            }

            try {
                const response = await fetch('/api/workout/log', {
                    method: 'POST',
                    headers: {
                        'Authorization': tg.initData,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                if (response.ok) {
                    // Clear saved session after successful save
                    clearWorkoutSession();
                    if (tg.HapticFeedback) {
                        tg.HapticFeedback.notificationOccurred('success');
                    }
                    tg.close();
                } else {
                    tg.showAlert('Помилка збереження тренування');
                }
            } catch (err) {
                console.error('Failed to save workout:', err);
                tg.showAlert('Помилка збереження');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Завершити тренування';
                }
            }
        }

        // Back button initial setup
        setBackButton(() => { tg.close(); });

        // Hide main button (we use in-page button instead)
        tg.MainButton.hide();

        // Delete functions
        async function deleteExercise(event, idx) {
            event.stopPropagation();

            const ex = exercises[idx];
            const exerciseName = ex.exercise;

            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');

            tg.showConfirm(
                `Видалити вправу "${exerciseName}"?`,
                async (confirmed) => {
                    if (!confirmed) return;

                    try {
                        const response = await fetch(
                            `/api/workout/exercise?user=${encodeURIComponent(PARAM_USER)}&day=${encodeURIComponent(PARAM_DAY)}&exercise=${encodeURIComponent(exerciseName)}`,
                            {
                                method: 'DELETE',
                                headers: {
                                    'Authorization': tg.initData,
                                },
                            }
                        );

                        if (response.ok) {
                            if (tg.HapticFeedback) {
                                tg.HapticFeedback.notificationOccurred('success');
                            }
                            // Reload the program
                            await loadProgram();
                            showListView();
                        } else {
                            tg.showAlert('Помилка видалення вправи');
                        }
                    } catch (err) {
                        console.error('Failed to delete exercise:', err);
                        tg.showAlert('Помилка видалення вправи');
                    }
                }
            );
        }

        async function deleteWorkoutDay() {
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');

            tg.showConfirm(
                `Видалити всі вправи з дня ${PARAM_DAY}?`,
                async (confirmed) => {
                    if (!confirmed) return;

                    try {
                        const response = await fetch(
                            `/api/workout/day?user=${encodeURIComponent(PARAM_USER)}&day=${encodeURIComponent(PARAM_DAY)}`,
                            {
                                method: 'DELETE',
                                headers: {
                                    'Authorization': tg.initData,
                                },
                            }
                        );

                        if (response.ok) {
                            if (tg.HapticFeedback) {
                                tg.HapticFeedback.notificationOccurred('success');
                            }
                            tg.close();
                        } else {
                            tg.showAlert('Помилка видалення дня');
                        }
                    } catch (err) {
                        console.error('Failed to delete day:', err);
                        tg.showAlert('Помилка видалення дня');
                    }
                }
            );
        }

        // Initialize
        async function init() {
            initHeader();
            await loadProgram();

            if (exercises.length === 0) {
                document.getElementById('loadingState').textContent = 'Немає вправ для обраної програми';
                return;
            }

            await loadLastLogs();

            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('bottomBar').style.display = 'flex';

            startWorkoutTimer();
            showListView();

            // Add click handler for rest timer
            document.getElementById('restTimer').addEventListener('click', function() {
                if (restTimerInterval) {
                    // If timer is running, stop it and show modal to change time
                    clearInterval(restTimerInterval);
                    restTimerInterval = null;
                    this.classList.remove('rest-timer-active');
                    restNotificationScheduled = false;
                    if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
                }
                // Show modal to select new timer duration
                showRestTimerModal();
            });
        }

        init();
    </script>
</body>
</html>
